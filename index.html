<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MoneyFlow - Gestione Soldi</title>
    
    <!-- PWA Meta Tags -->
    <meta name="theme-color" content="#667eea">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="MoneyFlow">
    <meta name="mobile-web-app-capable" content="yes">
    
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap');
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Poppins', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 50%, #f093fb 100%);
            min-height: 100vh;
            color: #333;
            overflow-x: hidden;
        }
        
        /* Install Banner RIMOSSO - Non pi√π necessario */
        
        /* Date Alerts - Pi√π piccole e meno invadenti */
        .date-alerts {
            position: fixed;
            top: 80px;
            right: 20px;
            z-index: 999;
            max-width: 300px;
            width: 90%;
            max-height: 200px;
            overflow-y: auto;
        }
        
        .alert {
            background: linear-gradient(135deg, #e53e3e, #ff6b6b);
            color: white;
            padding: 10px 15px;
            border-radius: 10px;
            margin-bottom: 8px;
            box-shadow: 0 4px 15px rgba(229, 62, 62, 0.3);
            animation: slideInRight 0.4s ease-out;
            position: relative;
            overflow: hidden;
            font-size: 12px;
            line-height: 1.3;
        }
        
        .alert.warning {
            background: linear-gradient(135deg, #f6ad55, #ed8936);
        }
        
        .alert.info {
            background: linear-gradient(135deg, #667eea, #764ba2);
        }
        
        .alert .close-alert {
            position: absolute;
            top: 5px;
            right: 8px;
            background: none;
            border: none;
            color: white;
            font-size: 14px;
            cursor: pointer;
            opacity: 0.8;
            line-height: 1;
        }
        
        .alert .close-alert:hover {
            opacity: 1;
        }
        
        @keyframes slideInRight {
            from {
                opacity: 0;
                transform: translateX(100%);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }
        
        @keyframes slideDown {
            from {
                transform: translateY(-100%);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }
        
        /* Animazioni */
        @keyframes slideInUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }
        
        @keyframes shimmer {
            0% { background-position: -200% 0; }
            100% { background-position: 200% 0; }
        }
        
        .header {
            background: linear-gradient(135deg, rgba(255,255,255,0.2), rgba(255,255,255,0.1));
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255,255,255,0.2);
            padding: 15px;
            text-align: center;
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
            position: sticky;
            top: 0;
            z-index: 100;
            animation: slideInUp 0.8s ease-out;
        }
        
        .month-selector {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 15px;
        }
        
        .month-btn {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 14px;
            box-shadow: 0 3px 10px rgba(102, 126, 234, 0.4);
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }
        
        .month-btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
            transition: left 0.5s;
        }
        
        .month-btn:hover::before {
            left: 100%;
        }
        
        .month-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.6);
        }
        
        .current-month {
            font-size: 16px;
            font-weight: 600;
            color: white;
            text-shadow: 0 2px 10px rgba(0,0,0,0.3);
            min-width: 150px;
        }
        
        /* Riepilogo compatto in alto */
        .summary-compact {
            background: linear-gradient(135deg, rgba(0,0,0,0.3), rgba(0,0,0,0.1));
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255,255,255,0.2);
            color: white;
            padding: 20px;
            border-radius: 20px;
            margin-bottom: 25px;
            text-align: center;
            box-shadow: 0 6px 25px rgba(0,0,0,0.2);
            animation: slideInUp 0.6s ease-out;
        }
        
        .summary-compact h3 {
            font-size: 18px;
            margin-bottom: 15px;
            text-shadow: 0 2px 10px rgba(0,0,0,0.3);
        }
        
        .summary-grid {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 15px;
        }
        
        .summary-box {
            background: rgba(255,255,255,0.1);
            backdrop-filter: blur(10px);
            border-radius: 12px;
            padding: 15px 10px;
            border: 1px solid rgba(255,255,255,0.2);
            transition: transform 0.3s ease;
        }
        
        .summary-box:hover {
            transform: translateY(-2px);
        }
        
        .summary-box.income {
            border-left: 4px solid #68d391;
        }
        
        .summary-box.expense {
            border-left: 4px solid #ff6b6b;
        }
        
        .summary-box.balance {
            border-left: 4px solid #667eea;
        }
        
        .summary-label {
            font-size: 11px;
            opacity: 0.8;
            margin-bottom: 5px;
            font-weight: 500;
        }
        
        .summary-amount {
            font-size: 16px;
            font-weight: 700;
            text-shadow: 0 1px 3px rgba(0,0,0,0.3);
        }
        
        .container {
            display: flex;
            flex-direction: column;
            padding: 25px;
            gap: 25px;
            max-width: 1400px;
            margin: 0 auto;
        }
        
        .section {
            background: linear-gradient(135deg, rgba(255,255,255,0.25), rgba(255,255,255,0.15));
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255,255,255,0.2);
            border-radius: 25px;
            padding: 30px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
            flex: 1;
            animation: slideInUp 0.8s ease-out;
            position: relative;
            overflow: hidden;
        }
        
        .section::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, #667eea, #764ba2, #f093fb);
        }
        
        .section-title {
            font-size: 22px;
            font-weight: 700;
            margin-bottom: 25px;
            color: white;
            text-align: center;
            text-shadow: 0 2px 10px rgba(0,0,0,0.3);
            position: relative;
        }
        
        .section-title::after {
            content: '';
            position: absolute;
            bottom: -10px;
            left: 50%;
            transform: translateX(-50%);
            width: 60px;
            height: 3px;
            background: linear-gradient(90deg, #667eea, #f093fb);
            border-radius: 2px;
        }
        
        .category {
            margin-bottom: 25px;
        }
        
        .category-header {
            background: linear-gradient(135deg, rgba(255,255,255,0.3), rgba(255,255,255,0.1));
            backdrop-filter: blur(10px);
            padding: 15px 20px;
            border-radius: 15px;
            font-weight: 600;
            color: white;
            margin-bottom: 15px;
            text-shadow: 0 1px 5px rgba(0,0,0,0.3);
            border: 1px solid rgba(255,255,255,0.2);
            font-size: 16px;
            position: relative;
            overflow: hidden;
        }
        
        .category-header.expense {
            background: linear-gradient(135deg, rgba(229, 62, 62, 0.3), rgba(229, 62, 62, 0.1));
        }
        
        .category-header.income {
            background: linear-gradient(135deg, rgba(56, 161, 105, 0.3), rgba(56, 161, 105, 0.1));
        }
        
        .item {
            display: flex;
            flex-direction: column;
            padding: 15px 20px;
            margin: 10px 0;
            background: linear-gradient(135deg, rgba(255,255,255,0.2), rgba(255,255,255,0.1));
            backdrop-filter: blur(10px);
            border-radius: 15px;
            border: 1px solid rgba(255,255,255,0.2);
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
            animation: fadeIn 0.5s ease-out;
        }
        
        .item-main {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        
        .item-details {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 12px;
            opacity: 0.8;
        }
        
        .item::before {
            content: '';
            position: absolute;
            left: 0;
            top: 0;
            bottom: 0;
            width: 4px;
            background: linear-gradient(135deg, #667eea, #764ba2);
            transition: width 0.3s ease;
        }
        
        .item.expense::before {
            background: linear-gradient(135deg, #e53e3e, #ff6b6b);
        }
        
        .item.income::before {
            background: linear-gradient(135deg, #38a169, #68d391);
        }
        
        .item.urgent {
            border: 2px solid #e53e3e;
            background: linear-gradient(135deg, rgba(229, 62, 62, 0.2), rgba(255, 107, 107, 0.1));
            animation: pulse 2s infinite;
        }
        
        .item.warning {
            border: 2px solid #f6ad55;
            background: linear-gradient(135deg, rgba(246, 173, 85, 0.2), rgba(237, 137, 54, 0.1));
        }
        
        .item:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 25px rgba(0,0,0,0.2);
        }
        
        .item:hover::before {
            width: 8px;
        }
        
        .item-name {
            flex: 1;
            font-size: 15px;
            font-weight: 500;
            color: white;
            text-shadow: 0 1px 3px rgba(0,0,0,0.3);
        }
        
        .item-amount {
            font-weight: 700;
            min-width: 90px;
            text-align: right;
            font-size: 16px;
            color: white;
            text-shadow: 0 1px 3px rgba(0,0,0,0.3);
        }
        
        .item-date {
            font-size: 12px;
            color: rgba(255,255,255,0.8);
        }
        
        .days-remaining {
            font-size: 11px;
            padding: 2px 8px;
            border-radius: 10px;
            background: rgba(255,255,255,0.2);
        }
        
        .days-remaining.urgent {
            background: #e53e3e;
            color: white;
            animation: pulse 1s infinite;
        }
        
        .days-remaining.warning {
            background: #f6ad55;
            color: white;
        }
        
        .expense .item-amount {
            color: #ffb3b3;
        }
        
        .income .item-amount {
            color: #b3ffb3;
        }
        
        .total {
            background: linear-gradient(135deg, #4a5568, #2d3748);
            color: white;
            padding: 20px;
            border-radius: 20px;
            margin-top: 20px;
            text-align: center;
            font-weight: 700;
            font-size: 18px;
            box-shadow: 0 8px 25px rgba(0,0,0,0.3);
            position: relative;
            overflow: hidden;
        }
        
        .total::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: linear-gradient(45deg, transparent, rgba(255,255,255,0.1), transparent);
            transform: rotate(45deg);
            animation: shimmer 2s infinite;
        }
        
        .add-btn {
            position: fixed;
            bottom: 30px;
            right: 30px;
            width: 70px;
            height: 70px;
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border: none;
            border-radius: 50%;
            font-size: 28px;
            cursor: pointer;
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.4);
            z-index: 100;
            transition: all 0.3s ease;
            animation: pulse 2s infinite;
        }
        
        .add-btn:hover {
            transform: scale(1.1) rotate(90deg);
            box-shadow: 0 10px 30px rgba(102, 126, 234, 0.6);
        }
        
        .copy-fixed-btn {
            position: fixed;
            bottom: 120px;
            right: 30px;
            width: 60px;
            height: 60px;
            background: linear-gradient(135deg, #f093fb, #f5576c);
            color: white;
            border: none;
            border-radius: 50%;
            font-size: 20px;
            cursor: pointer;
            box-shadow: 0 6px 20px rgba(240, 147, 251, 0.4);
            z-index: 100;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .copy-fixed-btn:hover {
            transform: scale(1.1) rotate(-10deg);
            box-shadow: 0 8px 25px rgba(240, 147, 251, 0.6);
        }
        
        .copy-fixed-btn:active {
            transform: scale(0.95);
        }
        
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.6);
            backdrop-filter: blur(10px);
            z-index: 1000;
            align-items: center;
            justify-content: center;
            animation: fadeIn 0.3s ease-out;
            padding: 20px;
        }
        
        .modal-content {
            background: linear-gradient(135deg, rgba(255,255,255,0.25), rgba(255,255,255,0.15));
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255,255,255,0.2);
            padding: 40px;
            border-radius: 25px;
            width: 90%;
            max-width: 450px;
            box-shadow: 0 20px 50px rgba(0,0,0,0.3);
            animation: slideInUp 0.5s ease-out;
            position: relative;
            overflow: hidden;
            max-height: 85vh;
            overflow-y: auto;
            margin: auto;
        }
        
        .modal-content::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, #667eea, #764ba2, #f093fb);
        }
        
        .modal h3 {
            color: white;
            margin-bottom: 25px;
            text-align: center;
            font-size: 22px;
            font-weight: 600;
            text-shadow: 0 2px 10px rgba(0,0,0,0.3);
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-label {
            display: block;
            color: white;
            font-weight: 500;
            margin-bottom: 8px;
            font-size: 14px;
        }
        
        .modal input, .modal select {
            width: 100%;
            padding: 15px 20px;
            border: 2px solid rgba(255,255,255,0.3);
            border-radius: 15px;
            font-size: 16px;
            background: rgba(255,255,255,0.1);
            backdrop-filter: blur(10px);
            color: white;
            transition: all 0.3s ease;
            font-family: 'Poppins', sans-serif;
        }
        
        .modal input::placeholder {
            color: rgba(255,255,255,0.7);
        }
        
        .modal input:focus, .modal select:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 20px rgba(102, 126, 234, 0.3);
            transform: scale(1.02);
        }
        
        .modal select option {
            background: #2d3748;
            color: white;
        }
        
        .modal-buttons {
            display: flex;
            gap: 15px;
            margin-top: 30px;
        }
        
        .modal-btn {
            flex: 1;
            padding: 15px;
            border: none;
            border-radius: 15px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        
        .save-btn {
            background: linear-gradient(135deg, #38a169, #68d391);
            color: white;
            box-shadow: 0 4px 15px rgba(56, 161, 105, 0.4);
        }
        
        .save-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(56, 161, 105, 0.6);
        }
        
        .cancel-btn {
            background: linear-gradient(135deg, #e53e3e, #ff6b6b);
            color: white;
            box-shadow: 0 4px 15px rgba(229, 62, 62, 0.4);
        }
        
        .cancel-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(229, 62, 62, 0.6);
        }
        
        .edit-btn {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border: none;
            padding: 6px 10px;
            border-radius: 8px;
            font-size: 11px;
            cursor: pointer;
            margin-left: 8px;
            margin-right: 8px;
            transition: all 0.3s ease;
            box-shadow: 0 2px 8px rgba(102, 126, 234, 0.3);
        }
        
        .edit-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 3px 12px rgba(102, 126, 234, 0.5);
        }
        
        .delete-btn {
            background: linear-gradient(135deg, #e53e3e, #ff6b6b);
            color: white;
            border: none;
            padding: 6px 10px;
            border-radius: 8px;
            font-size: 11px;
            cursor: pointer;
            margin-left: 8px;
            transition: all 0.3s ease;
            box-shadow: 0 2px 8px rgba(229, 62, 62, 0.3);
        }
        
        .delete-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 3px 12px rgba(229, 62, 62, 0.5);
        }
        
        .sections-container {
            display: flex;
            flex-direction: row;
            gap: 20px;
        }
        
        .sections-container .section {
            flex: 1;
            min-width: 0; /* Permette al flex di ridursi oltre la larghezza del contenuto */
        }
        
        .summary::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, #667eea, #764ba2, #f093fb);
        }
        
        .summary h3 {
            font-size: 24px;
            margin-bottom: 25px;
            text-shadow: 0 2px 10px rgba(0,0,0,0.3);
        }
        
        .summary-item {
            display: flex;
            justify-content: space-between;
            margin: 15px 0;
            font-size: 16px;
            font-weight: 500;
            padding: 10px 0;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }
        
        .summary-total {
            border-top: 2px solid rgba(255,255,255,0.3);
            padding-top: 20px;
            margin-top: 20px;
            font-size: 20px;
            font-weight: 700;
            text-shadow: 0 2px 10px rgba(0,0,0,0.3);
        }
        
        .cash-item {
            opacity: 0.6;
            font-style: italic;
            position: relative;
        }
        
        .cash-item::after {
            content: 'üíµ (escluso)';
            font-size: 10px;
            margin-left: 10px;
            opacity: 0.7;
        }
        
        /* Responsive migliorato */
        @media (max-width: 768px) {
            .container {
                padding: 15px;
                gap: 20px;
            }
            
            .section {
                padding: 20px;
            }
            
            .header {
                padding: 12px;
            }
            
            .month-selector {
                gap: 12px;
            }
            
            .month-btn {
                padding: 6px 10px;
                font-size: 12px;
            }
            
            .current-month {
                font-size: 14px;
                min-width: 120px;
            }
            
            .add-btn {
                width: 60px;
                height: 60px;
                bottom: 20px;
                right: 20px;
                font-size: 24px;
            }
            
            .copy-fixed-btn {
                width: 50px;
                height: 50px;
                bottom: 90px;
                right: 20px;
                font-size: 18px;
            }
            
            .install-banner button {
                padding: 8px 15px;
                font-size: 12px;
                margin: 3px 5px;
            }
            
            .summary-grid {
                grid-template-columns: 1fr;
                gap: 10px;
            }
            
            .summary-compact {
                padding: 15px;
                margin-bottom: 20px;
            }
            
            .summary-compact h3 {
                font-size: 16px;
                margin-bottom: 12px;
            }
            
            .summary-box {
                padding: 12px 8px;
            }
            
            .summary-label {
                font-size: 10px;
            }
            
            .summary-amount {
                font-size: 14px;
            }
            
            .date-alerts {
                top: 70px;
                right: 10px;
                max-width: 250px;
                max-height: 150px;
            }
            
            .alert {
                padding: 8px 12px;
                font-size: 11px;
                border-radius: 8px;
                margin-bottom: 6px;
            }
            
            .alert .close-alert {
                top: 3px;
                right: 6px;
                font-size: 12px;
            }
        }
    </style>
</head>
<body>
    <!-- Banner di installazione RIMOSSO -->
    
    <!-- Alerts per scadenze -->
    <div class="date-alerts" id="date-alerts"></div>

    <div class="header">
        <div class="month-selector">
            <button class="month-btn" onclick="changeMonth(-1)"><i class="fas fa-chevron-left"></i></button>
            <span class="current-month" id="current-month"></span>
            <button class="month-btn" onclick="changeMonth(1)"><i class="fas fa-chevron-right"></i></button>
        </div>
    </div>
    
    <div class="container">
        <!-- Riepilogo Generale compatto in alto -->
        <div class="summary-compact">
            <h3><i class="fas fa-chart-pie"></i> Riepilogo Fisso</h3>
            <div class="summary-grid">
                <div class="summary-box income">
                    <div class="summary-label">Entrate Fisse</div>
                    <div class="summary-amount" id="total-fixed-income">‚Ç¨0</div>
                </div>
                <div class="summary-box expense">
                    <div class="summary-label">Spese Fisse</div>
                    <div class="summary-amount" id="total-fixed-expenses">‚Ç¨0</div>
                </div>
                <div class="summary-box balance">
                    <div class="summary-label">Rimanenze Fisse</div>
                    <div class="summary-amount" id="final-fixed-balance">‚Ç¨0</div>
                </div>
            </div>
        </div>
        
        <div class="sections-container">
            <div class="section">
                <div class="section-title"><i class="fas fa-calendar-check"></i> Entrate e Spese Fisse</div>
            
            <div class="category">
                <div class="category-header income"><i class="fas fa-plus-circle"></i> Entrate Fisse</div>
                <div class="total" style="margin-top: 10px; margin-bottom: 15px;">
                    <i class="fas fa-arrow-up"></i> Totale Entrate Fisse: <span id="fixed-income-total">‚Ç¨0</span>
                </div>
                <div id="fixed-income"></div>
            </div>
            
            <div class="category">
                <div class="category-header expense"><i class="fas fa-minus-circle"></i> Spese Fisse</div>
                <div class="total" style="margin-top: 10px; margin-bottom: 15px;">
                    <i class="fas fa-arrow-down"></i> Totale Spese Fisse: <span id="fixed-expenses-total">‚Ç¨0</span>
                </div>
                <div id="fixed-expenses"></div>
            </div>
            
            <div class="total" style="background: linear-gradient(135deg, #38a169, #2d7738);">
                <i class="fas fa-chart-line"></i> Rimanenze Fisse: <span id="fixed-total">‚Ç¨0</span>
            </div>
        </div>
        
        <div class="section">
            <div class="section-title"><i class="fas fa-calendar-alt"></i> Entrate e Spese del Mese</div>
            
            <div class="category">
                <div class="category-header income"><i class="fas fa-hand-holding-usd"></i> Entrate Extra</div>
                <div class="total" style="margin-top: 10px; margin-bottom: 15px;">
                    <i class="fas fa-arrow-up"></i> Totale Entrate Extra: <span id="variable-income-total">‚Ç¨0</span>
                </div>
                <div id="variable-income"></div>
            </div>
            
            <div class="category">
                <div class="category-header expense"><i class="fas fa-shopping-cart"></i> Spese Variabili</div>
                <div class="total" style="margin-top: 10px; margin-bottom: 15px;">
                    <i class="fas fa-arrow-down"></i> Totale Spese Variabili: <span id="variable-expenses-total">‚Ç¨0</span>
                </div>
                <div id="variable-expenses"></div>
            </div>
            
            <div class="total" style="background: linear-gradient(135deg, #38a169, #2d7738);">
                <i class="fas fa-calculator"></i> Totale Mese: <span id="variable-total">‚Ç¨0</span>
            </div>
        </div>
        </div>
    </div>
    
    <button class="add-btn" onclick="openModal()"><i class="fas fa-plus"></i></button>
    
    <!-- Pulsante per copiare spese fisse -->
    <button class="copy-fixed-btn" onclick="copyFixedExpenses()" title="Copia spese fisse nel mese corrente">
        <i class="fas fa-copy"></i>
    </button>
    
    <!-- Pulsante backup (nascosto, attivabile con doppio tap sulla scritta MoneyFlow) -->
    <button id="backup-btn" onclick="exportData()" style="display:none;" title="Esporta backup dati">
        <i class="fas fa-download"></i>
    </button>
    
    <!-- Modal per aggiungere/modificare elementi -->
    <div class="modal" id="modal">
        <div class="modal-content">
            <h3><i class="fas fa-plus-circle"></i> <span id="modal-title">Aggiungi Elemento</span></h3>
            
            <div class="form-group">
                <label class="form-label" for="item-name">Nome</label>
                <input type="text" id="item-name" placeholder="es. Mutuo casa, Stipendio..." />
            </div>
            
            <div class="form-group">
                <label class="form-label" for="item-amount">Importo (‚Ç¨)</label>
                <input type="number" id="item-amount" placeholder="0.00" step="0.01" />
            </div>
            
            <div class="form-group">
                <label class="form-label" for="item-date">Data Scadenza</label>
                <input type="date" id="item-date" />
            </div>
            
            <div class="form-group">
                <label class="form-label" for="item-type">Categoria</label>
                <select id="item-type">
                    <option value="fixed-expense">üí∏ Spesa Fissa</option>
                    <option value="fixed-income">üí∞ Entrata Fissa</option>
                    <option value="variable-expense">üõí Spesa Variabile</option>
                    <option value="variable-income">üíµ Entrata Extra</option>
                </select>
            </div>
            
            <div class="modal-buttons">
                <button class="modal-btn save-btn" onclick="saveItem()"><i class="fas fa-save"></i> Salva</button>
                <button class="modal-btn cancel-btn" onclick="closeModal()"><i class="fas fa-times"></i> Annulla</button>
            </div>
        </div>
    </div>
    
    <script>
        let currentMonth = new Date().getMonth();
        let currentYear = new Date().getFullYear();
        let editingIndex = -1;
        let deferredPrompt;
        let editingType = '';
        let dismissedAlerts = new Set(); // Per tracciare gli alert chiusi
        
        // Dati iniziali con date
        let data = {}; // Inizializzato vuoto, verr√† caricato da loadFromStorage()
        
        const monthNames = [
            "Gennaio", "Febbraio", "Marzo", "Aprile", "Maggio", "Giugno",
            "Luglio", "Agosto", "Settembre", "Ottobre", "Novembre", "Dicembre"
        ];
        
        // PWA Install Logic - DISABILITATO
        /*
        window.addEventListener('beforeinstallprompt', (e) => {
            console.log('üíæ PWA Install prompt disponibile');
            e.preventDefault();
            deferredPrompt = e;
            // showInstallBanner(); // DISABILITATO
        });
        */
        
        // Funzioni di installazione - DISABILITATE
        /*
        function showInstallBanner() {
            const banner = document.getElementById('install-banner');
            banner.style.display = 'block';
            
            setTimeout(() => {
                if (banner.style.display === 'block') {
                    dismissInstall();
                }
            }, 15000);
        }
        
        function installApp() {
            if (deferredPrompt) {
                deferredPrompt.prompt();
                deferredPrompt.userChoice.then((result) => {
                    if (result.outcome === 'accepted') {
                        console.log('‚úÖ PWA installata con successo!');
                        showAlert('üéâ App installata con successo!', 'info');
                    } else {
                        showDetailedInstructions();
                    }
                    deferredPrompt = null;
                });
                dismissInstall();
            } else {
                showDetailedInstructions();
            }
        }
        
        function showInstructions() {
            showDetailedInstructions();
        }
        
        function showDetailedInstructions() {
            const isAndroid = /Android/i.test(navigator.userAgent);
            const isIOS = /iPhone|iPad|iPod/i.test(navigator.userAgent);
            const isChrome = /Chrome/i.test(navigator.userAgent);
            const isSafari = /Safari/i.test(navigator.userAgent) && !/Chrome/i.test(navigator.userAgent);
            
            let instructions = '';
            
            if (isAndroid && isChrome) {
                instructions = `
ü§ñ ANDROID + CHROME:

‚úÖ METODO 1 - Installazione App:
1. Tocca i 3 PUNTINI (‚ãÆ) in alto a destra
2. Cerca "Installa app" o "Aggiungi a schermata Home"  
3. Tocca "Installa" ‚Üí L'app apparir√† nella home!

‚úÖ METODO 2 - Se non vedi "Installa app":
1. Tocca i 3 PUNTINI (‚ãÆ)
2. "Aggiungi a schermata Home"
3. Dai un nome ‚Üí "Aggiungi"

üîÑ Se non funziona:
- Ricarica la pagina (F5)
- Aspetta 5 secondi
- Riprova i passaggi sopra
                `;
            } else if (isAndroid) {
                instructions = `
ü§ñ ANDROID (Altri Browser):

‚ö†Ô∏è Per la migliore esperienza, usa CHROME:
1. Apri Chrome
2. Vai a questo file HTML
3. Segui le istruzioni per Chrome

üì± Con browser attuale:
1. Menu ‚Üí "Aggiungi a schermata Home"
2. O crea un segnalibro
3. Mettilo nella schermata principale
                `;
            } else if (isIOS && isSafari) {
                instructions = `
üçé iPhone/iPad + SAFARI:

‚úÖ INSTALLAZIONE:
1. Tocca il pulsante CONDIVIDI (‚ñ°‚Üó) in basso
2. Scorri le opzioni fino a "Aggiungi a Home"
3. Tocca "Aggiungi a Home"
4. Personalizza il nome se vuoi
5. Tocca "Aggiungi" in alto a destra

‚ú® L'app apparir√† nella tua home screen!

üîç Non vedi "Aggiungi a Home"?
- Scorri le opzioni verso il basso
- Dovrebbe essere insieme agli altri pulsanti
                `;
            } else if (isIOS) {
                instructions = `
üçé iPhone/iPad (Browser non Safari):

‚ö†Ô∏è Per installare come app, usa SAFARI:
1. Apri Safari
2. Vai a questo file HTML  
3. Usa il pulsante Condividi ‚Üí "Aggiungi a Home"

üì± Con browser attuale:
- Crea un segnalibro
- Aggiungilo alla schermata Home manualmente
                `;
            } else {
                instructions = `
üíª DESKTOP/COMPUTER:

‚úÖ CHROME/EDGE:
1. Guarda la barra degli indirizzi
2. Cerca l'icona "Installa" ‚äï
3. Cliccaci sopra ‚Üí "Installa"

‚úÖ ALTERNATIVA:
1. Menu (‚ãÆ) ‚Üí "Installa MoneyFlow"
2. O "Aggiungi al desktop"

üìÅ METODO UNIVERSALE:
1. Salva il file HTML sul desktop
2. Crea un collegamento
3. Personalizza l'icona se vuoi
                `;
            }
            
            // Mostra le istruzioni in un alert pi√π leggibile
            showInstructionModal(instructions);
        }
        
        function showInstructionModal(instructions) {
            // Crea un modal personalizzato per le istruzioni
            const modal = document.createElement('div');
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background: rgba(0,0,0,0.8);
                z-index: 9999;
                display: flex;
                align-items: center;
                justify-content: center;
                padding: 20px;
            `;
            
            const content = document.createElement('div');
            content.style.cssText = `
                background: linear-gradient(135deg, #667eea, #764ba2);
                color: white;
                padding: 30px;
                border-radius: 20px;
                max-width: 500px;
                max-height: 80vh;
                overflow-y: auto;
                box-shadow: 0 20px 50px rgba(0,0,0,0.5);
                position: relative;
            `;
            
            content.innerHTML = `
                <button onclick="this.closest('div').remove()" style="
                    position: absolute;
                    top: 15px;
                    right: 15px;
                    background: rgba(255,255,255,0.2);
                    color: white;
                    border: none;
                    width: 30px;
                    height: 30px;
                    border-radius: 50%;
                    cursor: pointer;
                    font-size: 16px;
                ">√ó</button>
                <h3 style="margin-bottom: 20px; text-align: center;">
                    üì± Come Installare MoneyFlow
                </h3>
                <pre style="
                    white-space: pre-wrap;
                    font-family: 'Poppins', sans-serif;
                    line-height: 1.5;
                    font-size: 14px;
                ">${instructions}</pre>
                <div style="text-align: center; margin-top: 20px;">
                    <button onclick="this.closest('div').remove()" style="
                        background: rgba(255,255,255,0.2);
                        color: white;
                        border: 2px solid white;
                        padding: 12px 24px;
                        border-radius: 25px;
                        cursor: pointer;
                        font-weight: 600;
                    ">Ho Capito</button>
                </div>
            `;
            
            modal.appendChild(content);
            document.body.appendChild(modal);
            
            // Chiudi cliccando fuori
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    modal.remove();
                }
            });
        }
        
        function dismissInstall() {
            document.getElementById('install-banner').style.display = 'none';
        }
        */
        
        // Sistema di Alert per scadenze migliorato
        function showAlert(message, type = 'info', persistent = false, alertId = null) {
            // Se l'alert √® gi√† stato chiuso, non mostrarlo
            if (alertId && dismissedAlerts.has(alertId)) {
                return;
            }
            
            const alertsContainer = document.getElementById('date-alerts');
            const alert = document.createElement('div');
            alert.className = `alert ${type}`;
            alert.innerHTML = `
                <div style="margin-right: 20px;">${message}</div>
                <button class="close-alert" onclick="dismissAlert(this, '${alertId || ''}')" title="Chiudi notifica">√ó</button>
            `;
            
            alertsContainer.appendChild(alert);
            
            // Auto-remove per alert non persistenti
            if (!persistent) {
                setTimeout(() => {
                    if (alert.parentElement) {
                        alert.remove();
                    }
                }, 4000);
            }
        }
        
        function dismissAlert(buttonElement, alertId) {
            // Aggiungi alla lista degli alert chiusi se ha un ID
            if (alertId) {
                dismissedAlerts.add(alertId);
            }
            
            // Rimuovi l'alert
            buttonElement.parentElement.remove();
        }
        
        function checkUpcomingDues() {
            const today = new Date();
            const alerts = [];
            
            // Controlla spese fisse
            data.fixedExpenses.forEach((item, index) => {
                if (item.date) {
                    const dueDate = new Date(item.date);
                    const daysDiff = Math.ceil((dueDate - today) / (1000 * 60 * 60 * 24));
                    const alertId = `fixed-expense-${index}-${item.date}`;
                    
                    if (daysDiff <= 0 && daysDiff >= -1) {
                        alerts.push({
                            message: `‚ö†Ô∏è SCADUTA: ${item.name} (‚Ç¨${item.amount})`,
                            type: 'urgent',
                            alertId: alertId,
                            persistent: true
                        });
                    } else if (daysDiff <= 3 && daysDiff > 0) {
                        alerts.push({
                            message: `üö® ${item.name} scade tra ${daysDiff} giorni (‚Ç¨${item.amount})`,
                            type: 'urgent',
                            alertId: alertId,
                            persistent: true
                        });
                    } else if (daysDiff <= 7 && daysDiff > 3) {
                        alerts.push({
                            message: `‚ö° ${item.name} scade tra ${daysDiff} giorni (‚Ç¨${item.amount})`,
                            type: 'warning',
                            alertId: alertId
                        });
                    }
                }
            });
            
            // Controlla entrate fisse
            data.fixedIncome.forEach((item, index) => {
                if (item.date) {
                    const dueDate = new Date(item.date);
                    const daysDiff = Math.ceil((dueDate - today) / (1000 * 60 * 60 * 24));
                    const alertId = `fixed-income-${index}-${item.date}`;
                    
                    if (daysDiff <= 2 && daysDiff >= 0) {
                        alerts.push({
                            message: `üí∞ ${item.name} in arrivo tra ${daysDiff} giorni (‚Ç¨${item.amount})`,
                            type: 'info',
                            alertId: alertId
                        });
                    }
                }
            });
            
            // Mostra solo gli alert non ancora chiusi
            alerts.forEach(alert => {
                showAlert(alert.message, alert.type, alert.persistent || false, alert.alertId);
            });
        }
        
        function getDaysRemaining(date) {
            if (!date) return null;
            const today = new Date();
            const dueDate = new Date(date);
            return Math.ceil((dueDate - today) / (1000 * 60 * 60 * 24));
        }
        
        function formatDate(dateString) {
            if (!dateString) return '';
            const date = new Date(dateString);
            return date.toLocaleDateString('it-IT', { day: '2-digit', month: '2-digit' });
        }
        
        function getItemClass(date, baseClass) {
            const days = getDaysRemaining(date);
            if (days === null) return baseClass;
            
            if (days <= 0) return `${baseClass} urgent`;
            if (days <= 3) return `${baseClass} urgent`;
            if (days <= 7) return `${baseClass} warning`;
            return baseClass;
        }
        
        function getDaysRemainingText(days) {
            if (days === null) return '';
            if (days < 0) return 'SCADUTO';
            if (days === 0) return 'OGGI';
            if (days === 1) return 'DOMANI';
            return `${days}g`;
        }
        
        function getDaysRemainingClass(days) {
            if (days === null) return '';
            if (days <= 0) return 'urgent';
            if (days <= 3) return 'urgent';
            if (days <= 7) return 'warning';
            return '';
        }
        
        function getCurrentMonthKey() {
            return `${currentYear}-${currentMonth}`;
        }
        
        function initMonthlyData() {
            const key = getCurrentMonthKey();
            if (!data.monthlyData[key]) {
                data.monthlyData[key] = {
                    variableExpenses: [],
                    variableIncome: []
                };
            }
        }
        
        function updateDisplay() {
            document.getElementById('current-month').textContent = 
                `${monthNames[currentMonth]} ${currentYear}`;
            
            initMonthlyData();
            
            renderFixedExpenses();
            renderFixedIncome();
            renderVariableExpenses();
            renderVariableIncome();
            updateTotals();
            
            // Mostra gli alert solo se non ci sono alert attivi
            const alertsContainer = document.getElementById('date-alerts');
            if (alertsContainer.children.length === 0) {
                checkUpcomingDues();
            }
        }
        
        function renderFixedExpenses() {
            const container = document.getElementById('fixed-expenses');
            container.innerHTML = '';
            
            data.fixedExpenses.forEach((item, index) => {
                const days = getDaysRemaining(item.date);
                const div = document.createElement('div');
                div.className = getItemClass(item.date, 'item expense');
                div.innerHTML = `
                    <div class="item-main">
                        <span class="item-name"><i class="fas fa-home"></i> ${item.name}</span>
                        <span class="item-amount">‚Ç¨${item.amount.toFixed(2)}</span>
                        <button class="edit-btn" onclick="editFixedExpense(${index})"><i class="fas fa-edit"></i></button>
                        <button class="delete-btn" onclick="deleteFixedExpense(${index})"><i class="fas fa-trash"></i></button>
                    </div>
                    <div class="item-details">
                        <span class="item-date">${item.date ? formatDate(item.date) : 'Nessuna data'}</span>
                        ${days !== null ? `<span class="days-remaining ${getDaysRemainingClass(days)}">${getDaysRemainingText(days)}</span>` : ''}
                    </div>
                `;
                container.appendChild(div);
            });
        }
        
        function renderFixedIncome() {
            const container = document.getElementById('fixed-income');
            container.innerHTML = '';
            
            data.fixedIncome.forEach((item, index) => {
                const days = getDaysRemaining(item.date);
                const div = document.createElement('div');
                div.className = `${getItemClass(item.date, 'item income')} ${item.name.toLowerCase().includes('cash') ? 'cash-item' : ''}`;
                div.innerHTML = `
                    <div class="item-main">
                        <span class="item-name"><i class="fas fa-money-bill-wave"></i> ${item.name}</span>
                        <span class="item-amount">‚Ç¨${item.amount.toFixed(2)}</span>
                        <button class="edit-btn" onclick="editFixedIncome(${index})"><i class="fas fa-edit"></i></button>
                        <button class="delete-btn" onclick="deleteFixedIncome(${index})"><i class="fas fa-trash"></i></button>
                    </div>
                    <div class="item-details">
                        <span class="item-date">${item.date ? formatDate(item.date) : 'Nessuna data'}</span>
                        ${days !== null ? `<span class="days-remaining ${getDaysRemainingClass(days)}">${getDaysRemainingText(days)}</span>` : ''}
                    </div>
                `;
                container.appendChild(div);
            });
        }
        
        function renderVariableExpenses() {
            const container = document.getElementById('variable-expenses');
            const key = getCurrentMonthKey();
            container.innerHTML = '';
            
            if (data.monthlyData[key]?.variableExpenses) {
                data.monthlyData[key].variableExpenses.forEach((item, index) => {
                    const days = getDaysRemaining(item.date);
                    const div = document.createElement('div');
                    div.className = getItemClass(item.date, 'item expense');
                    div.innerHTML = `
                        <div class="item-main">
                            <span class="item-name"><i class="fas fa-shopping-bag"></i> ${item.name}</span>
                            <span class="item-amount">‚Ç¨${item.amount.toFixed(2)}</span>
                            <button class="edit-btn" onclick="editVariableExpense(${index})"><i class="fas fa-edit"></i></button>
                            <button class="delete-btn" onclick="deleteVariableExpense(${index})"><i class="fas fa-trash"></i></button>
                        </div>
                        <div class="item-details">
                            <span class="item-date">${item.date ? formatDate(item.date) : 'Nessuna data'}</span>
                            ${days !== null ? `<span class="days-remaining ${getDaysRemainingClass(days)}">${getDaysRemainingText(days)}</span>` : ''}
                        </div>
                    `;
                    container.appendChild(div);
                });
            }
        }
        
        function renderVariableIncome() {
            const container = document.getElementById('variable-income');
            const key = getCurrentMonthKey();
            container.innerHTML = '';
            
            if (data.monthlyData[key]?.variableIncome) {
                data.monthlyData[key].variableIncome.forEach((item, index) => {
                    const days = getDaysRemaining(item.date);
                    const div = document.createElement('div');
                    div.className = `${getItemClass(item.date, 'item income')} ${item.name.toLowerCase().includes('cash') ? 'cash-item' : ''}`;
                    div.innerHTML = `
                        <div class="item-main">
                            <span class="item-name"><i class="fas fa-piggy-bank"></i> ${item.name}</span>
                            <span class="item-amount">‚Ç¨${item.amount.toFixed(2)}</span>
                            <button class="edit-btn" onclick="editVariableIncome(${index})"><i class="fas fa-edit"></i></button>
                            <button class="delete-btn" onclick="deleteVariableIncome(${index})"><i class="fas fa-trash"></i></button>
                        </div>
                        <div class="item-details">
                            <span class="item-date">${item.date ? formatDate(item.date) : 'Nessuna data'}</span>
                            ${days !== null ? `<span class="days-remaining ${getDaysRemainingClass(days)}">${getDaysRemainingText(days)}</span>` : ''}
                        </div>
                    `;
                    container.appendChild(div);
                });
            }
        }
        
        function updateTotals() {
            const fixedExpensesTotal = data.fixedExpenses.reduce((sum, item) => sum + item.amount, 0);
            const fixedIncomeTotal = data.fixedIncome
                .filter(item => !item.name.toLowerCase().includes('cash'))
                .reduce((sum, item) => sum + item.amount, 0);
            
            const key = getCurrentMonthKey();
            const variableExpensesTotal = data.monthlyData[key]?.variableExpenses?.reduce((sum, item) => sum + item.amount, 0) || 0;
            const variableIncomeTotal = data.monthlyData[key]?.variableIncome
                ?.filter(item => !item.name.toLowerCase().includes('cash'))
                ?.reduce((sum, item) => sum + item.amount, 0) || 0;
            
            // Aggiorna i totali per categoria
            document.getElementById('fixed-expenses-total').textContent = `‚Ç¨${fixedExpensesTotal.toFixed(2)}`;
            document.getElementById('fixed-income-total').textContent = `‚Ç¨${fixedIncomeTotal.toFixed(2)}`;
            document.getElementById('variable-expenses-total').textContent = `‚Ç¨${variableExpensesTotal.toFixed(2)}`;
            document.getElementById('variable-income-total').textContent = `‚Ç¨${variableIncomeTotal.toFixed(2)}`;
            
            // Aggiorna i totali delle rimanenze
            document.getElementById('fixed-total').textContent = `‚Ç¨${(fixedIncomeTotal - fixedExpensesTotal).toFixed(2)}`;
            document.getElementById('variable-total').textContent = `‚Ç¨${(variableIncomeTotal - variableExpensesTotal).toFixed(2)}`;
            
            // Aggiorna il riepilogo compatto - SOLO FISSO
            const fixedBalance = fixedIncomeTotal - fixedExpensesTotal;
            
            document.getElementById('total-fixed-income').textContent = `‚Ç¨${fixedIncomeTotal.toFixed(2)}`;
            document.getElementById('total-fixed-expenses').textContent = `‚Ç¨${fixedExpensesTotal.toFixed(2)}`;
            
            const finalFixedBalanceElement = document.getElementById('final-fixed-balance');
            finalFixedBalanceElement.textContent = `‚Ç¨${fixedBalance.toFixed(2)}`;
            
            // Colora il bilancio fisso
            if (fixedBalance >= 0) {
                finalFixedBalanceElement.style.color = '#68d391';
                finalFixedBalanceElement.parentElement.style.borderLeftColor = '#68d391';
            } else {
                finalFixedBalanceElement.style.color = '#ff6b6b';
                finalFixedBalanceElement.parentElement.style.borderLeftColor = '#ff6b6b';
            }
        }
        
        function changeMonth(direction) {
            currentMonth += direction;
            if (currentMonth > 11) {
                currentMonth = 0;
                currentYear++;
            } else if (currentMonth < 0) {
                currentMonth = 11;
                currentYear--;
            }
            updateDisplay();
        }
        
        function openModal() {
            document.getElementById('modal').style.display = 'flex';
            document.getElementById('modal-title').textContent = 'Aggiungi Elemento';
            document.getElementById('item-name').value = '';
            document.getElementById('item-amount').value = '';
            document.getElementById('item-date').value = '';
            editingIndex = -1;
            editingType = '';
            
            // Previeni il scroll e mantieni la posizione
            const scrollY = window.scrollY;
            document.body.style.position = 'fixed';
            document.body.style.top = `-${scrollY}px`;
            document.body.style.width = '100%';
            
            // Focus dopo un breve delay per evitare problemi di rendering
            setTimeout(() => {
                document.getElementById('item-name').focus();
            }, 100);
        }
        
        function closeModal() {
            document.getElementById('modal').style.display = 'none';
            
            // Ripristina il scroll alla posizione precedente
            const scrollY = document.body.style.top;
            document.body.style.position = '';
            document.body.style.top = '';
            document.body.style.width = '';
            window.scrollTo(0, parseInt(scrollY || '0') * -1);
        }
        
        // Funzioni di modifica
        function editFixedExpense(index) {
            const item = data.fixedExpenses[index];
            openEditModal(item, 'fixed-expense', index);
        }
        
        function editFixedIncome(index) {
            const item = data.fixedIncome[index];
            openEditModal(item, 'fixed-income', index);
        }
        
        function editVariableExpense(index) {
            const key = getCurrentMonthKey();
            const item = data.monthlyData[key].variableExpenses[index];
            openEditModal(item, 'variable-expense', index);
        }
        
        function editVariableIncome(index) {
            const key = getCurrentMonthKey();
            const item = data.monthlyData[key].variableIncome[index];
            openEditModal(item, 'variable-income', index);
        }
        
        function openEditModal(item, type, index) {
            document.getElementById('modal').style.display = 'flex';
            document.getElementById('modal-title').textContent = 'Modifica Elemento';
            document.getElementById('item-name').value = item.name;
            document.getElementById('item-amount').value = item.amount;
            document.getElementById('item-date').value = item.date || '';
            document.getElementById('item-type').value = type;
            editingIndex = index;
            editingType = type;
            
            // Previeni il scroll e mantieni la posizione
            const scrollY = window.scrollY;
            document.body.style.position = 'fixed';
            document.body.style.top = `-${scrollY}px`;
            document.body.style.width = '100%';
            
            // Focus dopo un breve delay
            setTimeout(() => {
                document.getElementById('item-name').focus();
            }, 100);
        }
        
        function saveItem() {
            const name = document.getElementById('item-name').value.trim();
            const amount = parseFloat(document.getElementById('item-amount').value);
            const date = document.getElementById('item-date').value;
            const type = document.getElementById('item-type').value;
            
            if (!name || isNaN(amount)) {
                alert('‚ö†Ô∏è Inserisci nome e importo validi');
                return;
            }
            
            const item = {name, amount, date: date || null};
            
            // Se stiamo modificando un elemento esistente
            if (editingIndex !== -1 && editingType) {
                switch(editingType) {
                    case 'fixed-expense':
                        data.fixedExpenses[editingIndex] = item;
                        break;
                    case 'fixed-income':
                        data.fixedIncome[editingIndex] = item;
                        break;
                    case 'variable-expense':
                        initMonthlyData();
                        data.monthlyData[getCurrentMonthKey()].variableExpenses[editingIndex] = item;
                        break;
                    case 'variable-income':
                        initMonthlyData();
                        data.monthlyData[getCurrentMonthKey()].variableIncome[editingIndex] = item;
                        break;
                }
                showAlert('‚úÖ Elemento modificato con successo!', 'info');
            } else {
                // Altrimenti aggiungiamo un nuovo elemento
                switch(type) {
                    case 'fixed-expense':
                        data.fixedExpenses.push(item);
                        break;
                    case 'fixed-income':
                        data.fixedIncome.push(item);
                        break;
                    case 'variable-expense':
                        initMonthlyData();
                        data.monthlyData[getCurrentMonthKey()].variableExpenses.push(item);
                        break;
                    case 'variable-income':
                        initMonthlyData();
                        data.monthlyData[getCurrentMonthKey()].variableIncome.push(item);
                        break;
                }
                showAlert('‚úÖ Elemento aggiunto con successo!', 'info');
            }
            
            saveToStorage();
            updateDisplay();
            closeModal();
        }
        
        function deleteFixedExpense(index) {
            if (confirm('üóëÔ∏è Eliminare questa spesa fissa?')) {
                data.fixedExpenses.splice(index, 1);
                saveToStorage();
                updateDisplay();
                showAlert('üóëÔ∏è Spesa eliminata', 'info');
            }
        }
        
        function deleteFixedIncome(index) {
            if (confirm('üóëÔ∏è Eliminare questa entrata fissa?')) {
                data.fixedIncome.splice(index, 1);
                saveToStorage();
                updateDisplay();
                showAlert('üóëÔ∏è Entrata eliminata', 'info');
            }
        }
        
        function deleteVariableExpense(index) {
            if (confirm('üóëÔ∏è Eliminare questa spesa?')) {
                const key = getCurrentMonthKey();
                data.monthlyData[key].variableExpenses.splice(index, 1);
                saveToStorage();
                updateDisplay();
                showAlert('üóëÔ∏è Spesa eliminata', 'info');
            }
        }
        
        function deleteVariableIncome(index) {
            if (confirm('üóëÔ∏è Eliminare questa entrata?')) {
                const key = getCurrentMonthKey();
                data.monthlyData[key].variableIncome.splice(index, 1);
                saveToStorage();
                updateDisplay();
                showAlert('üóëÔ∏è Entrata eliminata', 'info');
            }
        }
        
        // Funzione per copiare tutte le spese fisse nelle spese variabili del mese corrente
        function copyFixedExpenses() {
            const key = getCurrentMonthKey();
            initMonthlyData();
            
            // Controlla se ci sono gi√† spese variabili questo mese
            const existingExpenses = data.monthlyData[key].variableExpenses.length;
            
            let confirmMessage = `üîÑ Copiare tutte le spese fisse (${data.fixedExpenses.length}) nelle spese variabili di ${monthNames[currentMonth]} ${currentYear}?`;
            
            if (existingExpenses > 0) {
                confirmMessage += `\n\n‚ö†Ô∏è Ci sono gi√† ${existingExpenses} spese variabili questo mese. Continuare?`;
            }
            
            if (!confirm(confirmMessage)) {
                return;
            }
            
            // Copia tutte le spese fisse
            let copiedCount = 0;
            
            data.fixedExpenses.forEach(expense => {
                // Crea una copia della spesa fissa
                const copiedExpense = {
                    name: expense.name,
                    amount: expense.amount,
                    date: expense.date
                };
                
                // Evita duplicati controllando se esiste gi√† una spesa con lo stesso nome
                const existingExpense = data.monthlyData[key].variableExpenses.find(
                    item => item.name.toLowerCase() === expense.name.toLowerCase()
                );
                
                if (!existingExpense) {
                    data.monthlyData[key].variableExpenses.push(copiedExpense);
                    copiedCount++;
                }
            });
            
            saveToStorage();
            updateDisplay();
            
            if (copiedCount > 0) {
                showAlert(`‚úÖ ${copiedCount} spese copiate con successo in ${monthNames[currentMonth]}!`, 'info');
            } else {
                showAlert(`‚ÑπÔ∏è Nessuna spesa copiata - potrebbero gi√† esistere spese con gli stessi nomi.`, 'warning');
            }
        }
        
        function saveToStorage() {
            try {
                // Salva nel localStorage del browser/webview
                const dataToSave = {
                    ...data,
                    lastUpdated: new Date().toISOString(),
                    version: '1.0'
                };
                localStorage.setItem('moneyflow_data', JSON.stringify(dataToSave));
                console.log('üíæ Dati salvati con successo:', dataToSave);
            } catch (e) {
                console.log('‚ùå Errore salvataggio:', e);
                // Fallback: prova sessionStorage
                try {
                    sessionStorage.setItem('moneyflow_data', JSON.stringify(data));
                    console.log('üíæ Fallback sessionStorage usato');
                } catch (e2) {
                    console.log('‚ùå Anche sessionStorage fallito:', e2);
                    showAlert('‚ö†Ô∏è Errore salvataggio dati', 'warning');
                }
            }
        }
        
        function loadFromStorage() {
            try {
                // Prova localStorage prima
                let savedData = localStorage.getItem('moneyflow_data');
                
                // Se non c'√® localStorage, prova sessionStorage  
                if (!savedData) {
                    savedData = sessionStorage.getItem('moneyflow_data');
                }
                
                if (savedData) {
                    const parsedData = JSON.parse(savedData);
                    
                    // Verifica che i dati abbiano la struttura corretta
                    if (parsedData.fixedExpenses && parsedData.fixedIncome) {
                        data = {
                            fixedExpenses: parsedData.fixedExpenses || [],
                            fixedIncome: parsedData.fixedIncome || [],
                            monthlyData: parsedData.monthlyData || {}
                        };
                        console.log('üìÇ Dati caricati con successo:', data);
                        showAlert('üìÇ Dati caricati dal backup locale', 'info');
                    } else {
                        console.log('‚ö†Ô∏è Dati corrotti, uso dati di default');
                        initializeDefaultData();
                    }
                } else {
                    console.log('üí≠ Nessun dato salvato, uso dati di default');
                    initializeDefaultData();
                }
            } catch (e) {
                console.log('‚ùå Errore caricamento:', e);
                initializeDefaultData();
                showAlert('‚ö†Ô∏è Errore caricamento, dati ripristinati', 'warning');
            }
        }
        
        function initializeDefaultData() {
            // Reset ai dati iniziali se non ci sono dati salvati o sono corrotti
            data = {
                fixedExpenses: [
                    {name: "mutuo casa", amount: 480, date: "2025-08-15"},
                    {name: "assicurazione auto", amount: 80, date: "2025-08-19"},
                    {name: "cucina", amount: 170, date: "2025-08-15"},
                    {name: "spesa cibo", amount: 600, date: "2025-08-23"},
                    {name: "carta credito american express", amount: 60, date: "2025-08-19"},
                    {name: "cessione del quinto", amount: 135, date: "2025-08-01"},
                    {name: "internet", amount: 26, date: "2025-08-26"},
                    {name: "bollette", amount: 150, date: "2025-08-20"},
                    {name: "scuola belle e liam", amount: 200, date: "2025-08-30"}
                ],
                fixedIncome: [
                    {name: "stipendio vlad", amount: 2335, date: "2025-08-02"},
                    {name: "assegno unico", amount: 470, date: "2025-08-20"}
                ],
                monthlyData: {}
            };
        }
        
        // Funzione per esportare dati come backup
        function exportData() {
            try {
                const dataToExport = {
                    ...data,
                    exportDate: new Date().toISOString(),
                    appVersion: '1.0'
                };
                
                const dataStr = JSON.stringify(dataToExport, null, 2);
                const blob = new Blob([dataStr], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                
                const a = document.createElement('a');
                a.href = url;
                a.download = `moneyflow_backup_${new Date().toISOString().split('T')[0]}.json`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                
                showAlert('üíæ Backup scaricato con successo!', 'info');
            } catch (e) {
                console.log('‚ùå Errore export:', e);
                showAlert('‚ùå Errore durante l\'export', 'warning');
            }
        }
        
        // Auto-save ogni 30 secondi
        setInterval(() => {
            saveToStorage();
        }, 30000);
        
        // Inizializzazione
        document.addEventListener('DOMContentLoaded', function() {
            // Carica i dati prima di tutto
            loadFromStorage();
            updateDisplay();
            
            // Banner installazione DISABILITATO
            /*
            setTimeout(() => {
                if (!window.matchMedia('(display-mode: standalone)').matches) {
                    showInstallBanner();
                }
            }, 2000);
            */
            
            // Controlla scadenze ogni 30 minuti
            setInterval(checkUpcomingDues, 30 * 60 * 1000);
            
            // Doppio tap sulla data corrente per mostrare backup (non pi√π su MoneyFlow che non c'√®)
            let tapCount = 0;
            document.getElementById('current-month').addEventListener('click', function() {
                tapCount++;
                setTimeout(() => { tapCount = 0; }, 500);
                if (tapCount === 2) {
                    const backupBtn = document.getElementById('backup-btn');
                    if (backupBtn.style.display === 'none') {
                        backupBtn.style.display = 'block';
                        showAlert('üîß Modalit√† sviluppatore attivata!', 'info');
                    }
                }
            });
            
            // Salvataggio automatico ogni volta che si chiude/minimizza l'app
            window.addEventListener('beforeunload', saveToStorage);
            window.addEventListener('pagehide', saveToStorage);
            
            // Per mobile - salva quando l'app va in background
            document.addEventListener('visibilitychange', function() {
                if (document.visibilityState === 'hidden') {
                    saveToStorage();
                }
            });
        });
        
        // Gestione modal
        document.getElementById('modal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeModal();
            }
        });
        
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                closeModal();
            }
        });
        
        // PWA detection - DISABILITATO
        /*
        window.addEventListener('appinstalled', (evt) => {
            console.log('üéâ PWA installata con successo!');
            dismissInstall();
            showAlert('üéâ MoneyFlow installata come app!', 'info');
        });
        */
        
        // Service Worker
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                const swScript = `
                    const CACHE_NAME = 'moneyflow-v2';
                    const urlsToCache = ['./'];
                    
                    self.addEventListener('install', (event) => {
                        event.waitUntil(
                            caches.open(CACHE_NAME)
                                .then((cache) => cache.addAll(urlsToCache))
                        );
                    });
                    
                    self.addEventListener('fetch', (event) => {
                        event.respondWith(
                            caches.match(event.request)
                                .then((response) => response || fetch(event.request))
                        );
                    });
                `;
                
                const blob = new Blob([swScript], { type: 'application/javascript' });
                const swUrl = URL.createObjectURL(blob);
                
                navigator.serviceWorker.register(swUrl)
                    .then((registration) => {
                        console.log('üîß Service Worker registrato');
                    })
                    .catch((error) => {
                        console.log('‚ùå Service Worker fallito:', error);
                    });
            });
        }
    </script>
</body>
</html>
